{% extends "views/shared/layout.html" %}
{% block scripts %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/1.3.2/wavesurfer.min.js"></script>
  <script src="https://wavesurfer-js.org/dist/plugin/wavesurfer.timeline.min.js"></script>
  <script src="https://wavesurfer-js.org/dist/plugin/wavesurfer.regions.min.js"></script>
  <style>
  /* Adds a seekbar to the waveform */
  #waveform > wave > wave { border-right: 1px solid rgba(255,192,160, 1.000) !important; }
  /* Used to display the icon outside of the wave (next style) */
  #waveform > wave { overflow: visible !important; }
  /* Display the comment/annotation icons slightly above their related segment. */
  .wavesurfer-region > i { margin-top: -15px; }
    /* Increases the width of the re-size handle and adds a color to make it clear where to re-size.
    This is a workaround as per issue #630 of wavesurfer */
  .wavesurfer-handle { background: rgba(0, 0, 0, 0.3); min-width: 4px; }
  #controls { float: right; }
  .chips-autocomplete .input { width: 260px !important; }
  .comment-header, .comment-body { padding: 18px; }
  .comment-header { background-color: #f6f8fa; border-bottom: 1px solid #d1d5da; }
  .comment-body > p:first-of-type { margin: 0; }
  .author { color: #586069; }
  #interviews { position: absolute; right: 0; width: 150px; z-index: 0; }
  #interviews > i { position: absolute; font-weight: 600; left: 0; z-index: 1012018; cursor: pointer; }
  .collection.with-header .collection-item { padding-left: 20px; margin-bottom: 0; }
  #connections > h5 { font-weight: 700; }
  .chip.selected { background-color: #4696BB; color: white; }
  .closeForm i { line-height: 25px; font-size: 1.4em; }
  .closeForm { width: 25px; height: 25px; line-height: 25px; }
  #codebook { margin: 25px 0;}
  </style>
{%- endblock %}
{% from "views/shared/macros.html" import render_comment %}
{% block content %}
        <div class="collection with-header right" id="interviews">
          <p class="collection-header"><b>Other interviews in this session</b></p>
          {%- for interview in interviews %}
          <a href="{{ url_for('project.session', interview_id=interview.id) }}"
             class="collection-item truncate tooltipped" data-position="left" data-delay="1" data-tooltip="{{ interview.prompt_text().title() }}">
            <b>{{ loop.index }}.</b> {{ interview.prompt_text().title() }}
          </a>{% endfor %}
        </div>

        <h5><b>{{ interview.prompt_text().capitalize() }}</b></h5>
        <p><i>{% for p in participants %} {{ p['name'] }}{% if not loop.last %},{% endif %}{% endfor %}</i></p>

        <div id="waveform"></div>
        <div id="waveform-timeline"></div>

        <div id="controls">
          <span onclick="wavesurfer.playPause()">
            <a class="btn waves-effect" id="play"><i class="material-icons">play_arrow</i></a>
            <a class="btn waves-effect" id="pause" style="display:none;"><i class="material-icons">pause</i></a>
          </span>
          <a class="btn waves-effect" id="createConnection">Create connection</a>
        </div>

        <div class="col s12 m6" id="connections">
          {%- if connections %}
           <h5>Connections made</h5>
            {%- for connection in connections %}
          <div class="commentContainer">
          {{ render_comment(connection) }}
          </div>
            {% endfor -%}
          {%- else %}
          <h5><b>What is a connection?</b></h5>
          <p id="instructions"><i>
          Connections are your understanding, reflection and opinions of a moment of an interview,
          which will be used to support dialogue between yourself, this client and other staff around
          <b>moments</b> of an interview that may otherwise be missed in conversation.</i></p>
          <h6><b>Creating connections</b></h6>
          <p>Once you click <i>create connection</i> you will be presented with a set of words/phrases
          to help you structure your reflection; choose those that best describe why you have chosen
          to create a connection for this moment, and write how this relates to your experiences.</p>
          <p>At the same time, you will notice a rectangle overlapped on a moment of the audio, which is the
          piece of the interview that you are making this connection with. You can increase/decrease the size
          of this moment by dragging a side in one both direction, drag it around the audio, and
          <code>Shift+Left-Click</code> will playback that moment of the audio.</p>
          {%- endif %}
        </div>


        <form method="POST" class="col s12" id="makeConnection" style="display:none;">
          <div class="row">
            <div class="input-field col s12">
                <span class="closeForm btn-floating right"><i class="material-icons">close</i></span>
                <h5>Select one of the following that describes this moment of the conversation</h5>
                <div id="codebook">
                {%- for code in interview.codebook() %}
                  <div class="chip" data-codeid="{{ code['id'] }}">{{ code['text'] }}</div>
                {%- endfor %}
                </div>
                <div class="input-field col s12">
                  <textarea id="justifyConnection" class="materialize-textarea" rows="4" autofocus></textarea>
                  <label for="justifyConnection">How did these words/phrases support you?</label>
                </div>
            </div>
            <div class="input-field col s12">
              <button class="btn waves-effect waves-light right" type="submit">Save</button>
            </div>
          </div>
        </form>

{%- endblock %}
{%- block fscripts %}
  <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/js/materialize.min.js"></script>
  <script>
    // Variables rendered here for future js refactoring as it
    // is not possible to render jinja2 variables inside JS files.
    var connections = {{ connections | safe }};
    var audioURL = "{{ interview.audio }}";
    var currentUserFullName = "{{ current_user.fullname }}";
    var currentInterviewID = {{ interview.id }};
    var createConnectionURL = "{{ url_for('api.create_connection', _external=True) }}";

    var wavesurfer = WaveSurfer.create({
        container: '#waveform',
        waveColor: 'rgba(153, 153, 153, 1.000)',
        progressColor: 'rgba(255,192,160, 1.000)',
        cursorColor: 'rgba(255, 0, 0, 0.0)',
        normalize: true
    });

    wavesurfer.on('play', function () {
        $('#play').hide();
        $('#pause').show();
    });

    wavesurfer.on('pause', function () {
        $('#play').show();
        $('#pause').hide();
    });

    // When audio is loaded, decoded and draw waveform. Fires before waveform is drawn.
    wavesurfer.on('ready', function () {
        connections.forEach(function(i) { addRegion(i, false, false); });
    });

    wavesurfer.on('region-in', function (region) {
        $('.r-'+region.id).show();
        $('.r-'+region.id).parent().show();
    });

    wavesurfer.on('region-out', function (region) {
        $('.r-'+region.id).hide();
        $('.r-'+region.id).parent().hide();
    });

    wavesurfer.on('region-click', function (region, e) {
        // Play on click, loop on shift click
        e.shiftKey ? region.playLoop() : region.play();
    });


    wavesurfer.load(audioURL);

    var timeline = Object.create(WaveSurfer.Timeline);

    timeline.init({
        wavesurfer: wavesurfer,
        container: '#waveform-timeline'
    });

    // // This is the region that will be created for a connection if the form is submitted
    var regionToCreate = {};

    function addRegionToCreate()
    {
        // The ID is set here be used as a lookup and not to clash with comment/annotation database IDs.
        regionToCreate = {
            'content' : "",
            'codes'   : [],
            'start'   : wavesurfer.getCurrentTime() - 10,
            'end'     : wavesurfer.getCurrentTime(),
            'creator' : currentUserFullName,
            'id'      : Math.floor(Math.random() * (100000 - 10000) + 10000),
            'iid'     : currentInterviewID
        };
        addRegion(regionToCreate, true, true);
    }

    function addRegion(item, drag, resize)
    {
        wavesurfer.addRegion(
        {
            id: item.id,
            start: item.start,
            end: item.end,
            data: {
                content: item.content,
                codes: item.codes,
                author: item.creator,
                timestamp: item.timestamp,
                days_since: item.days_since
            },
            drag: drag,
            resize: resize
        });
        // Only difference here would be the fact that you can have 'yours' and 'theirs'?
        $('[data-id=' + item.id + ']').append('<i class="material-icons tiny right">bookmark_border</i>');
    }

    function POSTConnection(codes, justification)
    {
        // Update local prior to pushing to server
        regionToCreate.codes = codes;
        regionToCreate.content = justification;
        regionToCreate.start = wavesurfer.regions.list[regionToCreate.id].start;
        regionToCreate.end = wavesurfer.regions.list[regionToCreate.id].end;

        // Update on local machine to reflect view on refresh
        wavesurfer.regions.list[regionToCreate.id].data.content = justification;
        wavesurfer.regions.list[regionToCreate.id].data.codes = codes;
        wavesurfer.regions.list[regionToCreate.id].drag = false;
        wavesurfer.regions.list[regionToCreate.id].resize = false;

        $.ajax({
            type     : 'POST',
            url      : createConnectionURL,
            data     : JSON.stringify(regionToCreate),
            contentType: "application/json",
            dataType: 'json'
        }).done(function(data) {
            if(data.success) {
                Materialize.toast("Thanks for adding making a connection");
            }
        });
    }

    // Show the connection form (codes/why) and hide connections/controls
    function toggleConnectionForm()
    {
        $('#makeConnection').toggle();
        $('#controls').toggle();
        $('#connections').toggle();
        $('#justifyConnection').focus();
    }

    var displayInstructionsOnce = false;

    $(document).ready(function() {

        $( "#createConnection" ).bind( "click", function() {
            toggleConnectionForm();
            // Allows user to focus on creating connection.
            wavesurfer.pause();

            if (!displayInstructionsOnce)  {
                Materialize.toast('Drag a region left or right to increase its size', 4500);
                Materialize.toast('Shift+Click to playback the region.', 4500);
                displayInstructionsOnce = true;
            }

            addRegionToCreate();
        });

        $( ".closeForm" ).bind( "click", function() {
            toggleConnectionForm();
            wavesurfer.play();
            wavesurfer.regions.list[regionToCreate.id].remove();
        });

        $('#makeConnection').submit(function(event) {
            // Store all IDs of the selected codes.
            selectedCodes = [];
            $('.selected').show().each(function() { selectedCodes.push($(this).data("codeid")); });
            // TODO: validate...
            toggleConnectionForm();
            wavesurfer.play();
            event.preventDefault();
            POSTConnection(selectedCodes, $('#justifyConnection').val());
        });

        $(".chip").click(function() { $(this).toggleClass("selected", "selected"); });
    });

  </script>
{%- endblock %}
