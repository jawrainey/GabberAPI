{% extends "views/shared/layout.html" %}
{% block scripts %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/1.3.2/wavesurfer.min.js"></script>
  <script src="https://wavesurfer-js.org/dist/plugin/wavesurfer.timeline.min.js"></script>
  <script src="https://wavesurfer-js.org/dist/plugin/wavesurfer.regions.min.js"></script>
  <style>
  /* Adds a seekbar to the waveform */
  #waveform > wave > wave { border-right: 1px solid rgba(255,192,160, 1.000) !important; }
  /* Used to display the icon outside of the wave (next style) */
  #waveform > wave { overflow: visible !important; }
  /* Display the comment/annotation icons slightly above their related segment. */
  .wavesurfer-region > i { margin-top: -5px; }
  /* Force the controls to the bottom. */
  #controls { position: absolute; bottom: 80px; left: 39%; }
  .chips-autocomplete .input { width: 250px !important; }
  </style>
{%- endblock %}
{% block content %}
        <h5><b>Participants:</b>{% for p in participants %} {{ p['name'] }}{% if not loop.last %},{% endif %}{% endfor %}</h5>

        <div id="waveform"></div>
        <div id="waveform-timeline"></div>

        <div class="row">
          <div class="col s12 m6" id="comments">
            <h5>Comments</h5>
          </div>
          <div class="col s12 m6" id="annotations">
            <h5>Annotations</h5>
          </div>
        </div>

        <div id="controls">
          <a class="btn-floating waves-effect tooltipped" data-position="top" data-delay="40" data-tooltip="Create annotation" onclick="showAnnotationForm()"><i class="material-icons">label_outline</i></a>
          <span onclick="wavesurfer.playPause()">
            <a class="btn-large btn-floating waves-effect" id="play"><i class="material-icons">play_arrow</i></a>
            <a class="btn-large btn-floating waves-effect" id="pause" style="display: none"><i class="material-icons">pause</i></a>
          </span>
          <a class="btn-floating waves-effect tooltipped" data-position="top" data-delay="40" data-tooltip="Create comment" onclick="showCommentForm()"><i class="material-icons">comment</i></a>
        </div>

        <form method="POST" class="col s12" id="commentForm" style="display: none">
          <div class="row">
            <span class="closeForm btn-floating right"><i class="material-icons">close</i></span>
            <div class="input-field col s12">
              <textarea id="content" class="materialize-textarea" rows="3" name="content" maxlength=280 required autofocus></textarea>
              <label for="content">Add your comment</label>
            </div>
            <div class="input-field col s12">
              <button class="btn waves-effect waves-light right" type="submit">Save</button>
            </div>
          </div>
        </form>

        <form method="POST" class="col s12" id="annotationForm" style="display: none">
          <div class="row">
            <span class="closeForm btn-floating right"><i class="material-icons">close</i></span>
            <div class="input-field col s12 tooltipped" data-position="bottom" data-delay="40" data-tooltip="Type your annotation & press <i>enter</i> to create it. You can add as many as you like.">
              <div class="chips chips-autocomplete"></div>
            </div>
            <div class="input-field col s12">
                <button class="btn waves-effect waves-light right" type="submit">Save</button>
            </div>
          </div>
        </form>
{%- endblock %}
{%- block fscripts %}
  <script>
    var wavesurfer = WaveSurfer.create({
        container: '#waveform',
        waveColor: 'rgba(153, 153, 153, 1.000)',
        progressColor: 'rgba(255,192,160, 1.000)',
        cursorColor: 'rgba(255, 0, 0, 0.0)',
        normalize: true
    });

    wavesurfer.on('play', function () {
        document.querySelector('#play').style.display = 'none';
        document.querySelector('#pause').style.display = '';
    });

    wavesurfer.on('pause', function () {
        document.querySelector('#play').style.display = '';
        document.querySelector('#pause').style.display = 'none';
    });

    wavesurfer.on('region-in', function (region) {
        if (region.data.type == 0) {
            $('#comments').append(
                "<div class=\"r-" + region.id + " card-panel\">" +
                "  <span class=\"black-text\">" +
                      region.data.content +
                "  </span>" +
                "</div>");

            $('#comments').show();
        }
        else {
            JSON.parse(region.data.content).forEach(function(item) {
                $('#annotations').append(
                    "<div class=\"r-" + region.id + " chip\">" + item.tag + "</div>"
                );
            });
            $('#annotations').show();
        }
    });

    wavesurfer.on('region-out', function (region) {
        $('.r-'+region.id).remove();
    });

    // When audio is loaded, decoded and draw waveform. Fires before waveform is drawn.
    wavesurfer.on('ready', function () {
        {{ comments | safe }}.forEach(function(i) { addRegion(i, false, false); });
        {{ annotations | safe }}.forEach(function(i) { addRegion(i, false, false); });
    });

    wavesurfer.load('{{ interview.audio }}');

    var timeline = Object.create(WaveSurfer.Timeline);

    timeline.init({
        wavesurfer: wavesurfer,
        container: '#waveform-timeline'
    });

    // This is the region that will be created for an annotation/comment if the form is submitted
    var regionToCreate = {};

    function showAnnotationForm()
    {
        wavesurfer.pause();
        // When the annotation button is clicked and the form is open.
        if ($('#annotationForm').is(":visible")) {
            $('#annotationForm').hide();
            $('#comments').show();
            $('#annotations').show();
            // The 'Annotate' button was clicked again,
            // so remove the region previously added as it was not saved.
            wavesurfer.regions.list[regionToCreate.id].remove();
            regionToCreate = {};
        }
        else {
            $(".chips-autocomplete").addClass("focus");
            $('#annotationForm button').addClass('disabled');
            $('#annotationForm').show();
            $('#commentForm').hide();
            $('#comments').hide();
            $('#annotations').hide();
            $('#controls').hide();
            $('.chips-autocomplete .chip').remove();
            // Required to remove old (tags) from the data array/
            $('.chips-autocomplete').material_chip('data').length = 0;
            updateRegionToCreate(1);
        }
    }

    function showCommentForm()
    {
        wavesurfer.pause();

        if ($('#commentForm').is(":visible")) {
            $('#commentForm').hide();
            $('#comments').show();
            $('#annotations').show();
            wavesurfer.regions.list[regionToCreate.id].remove();
            regionToCreate = {};
        }
        else {
            $('#commentForm').show();
            $('#annotationForm').hide();
            $('#comments').hide();
            $('#annotations').hide();
            $('#controls').hide();
            $('textarea[name=content]').val("");

            updateRegionToCreate(0);

            Materialize.updateTextFields();
        }
    }

    function updateRegionToCreate(type)
    {
            _content = (type === 0) ? $('textarea[name=content]').val() : JSON.stringify($('.chips-autocomplete').material_chip('data'));

            // The ID is set here be used as a lookup and not to clash with comment/annotation database IDs.
            regionToCreate = {
                'content' : _content,
                'start'   : wavesurfer.getCurrentTime() - 10,
                'end'     : wavesurfer.getCurrentTime(),
                'type'    : type,
                'id'      : Math.floor(Math.random() * (100000 - 10000) + 10000),
                'iid'     : {{ interview.id }}
            };

            addRegion(regionToCreate, true, true);
    }

    /**
     * Used when initially adding regions to the waveform, AND when adding a new
     * comment or annotation, hence the need to customize drag/resize as these are
     * not desired for all comments.
     */
    function addRegion(item, drag, resize)
    {
        wavesurfer.addRegion(
        {
            id: item.id,
            start: item.start,
            end: item.end,
            data: {
                content: item.content,
                type: item.type
            },
            drag: drag,
            resize: resize
        });

        var type = (item.type === 0) ? "comment" : "label_outline";
        $('[data-id=' + item.id + ']').append('<i class="material-icons tiny right">' + type + '</i>');
    }

    function postForm()
    {
        _content = (regionToCreate.type === 0) ? $('textarea[name=content]').val() : JSON.stringify($('.chips-autocomplete').material_chip('data'));

        // Update local prior to pushing to server
        regionToCreate.content = _content;
        regionToCreate.start = wavesurfer.regions.list[regionToCreate.id].start;
        regionToCreate.end = wavesurfer.regions.list[regionToCreate.id].end;

        // Update on local machine to reflect view on refresh
        wavesurfer.regions.list[regionToCreate.id].data.content = _content;
        wavesurfer.regions.list[regionToCreate.id].drag = false;
        wavesurfer.regions.list[regionToCreate.id].resize = false;

        $.ajax({
            type     : 'POST',
            url      : '{{ url_for('project.interview_response', _external=True) }}',
            data     : regionToCreate,
            dataType : 'json',
            encode   : true
        }).done(function(data) {
            if(data.success) {
                Materialize.toast("Thanks for adding your " + (regionToCreate.type === 0 ? "comment" : "annotation"), 4000);
                wavesurfer.play();
            }
        });
        $('#comments').show();
        $('#annotations').show();
        $('#controls').show();
        // Once a comment OR annotation is made, then do not show the tooltips again.
        $('.tooltipped').tooltip('remove');
        wavesurfer.playPause();
    }

    $(document).ready(function() {

        $('.chips-autocomplete').material_chip({
            autocompleteData: {{ annotations | safe }},
            autocompleteLimit: 5,
            placeholder: 'Add another annotation?',
            secondaryPlaceholder: 'Press enter to create your annotation'
        });

        // Using AJAX as we want to stay on this page when the form is submitted.
        $('#commentForm').submit(function(event) {
            $('#commentForm').toggle();
            postForm();
            event.preventDefault();
        });

        $('#annotationForm').submit(function(event) {
            $('#annotationForm').toggle();
            postForm();
            event.preventDefault();
        });

        $( ".closeForm" ).bind( "click", function() {
            $('#commentForm').hide();
            $('#annotationForm').hide();
            $('#controls').show();

            $('#comments').show();
            $('#annotations').show();

            $('.tooltipped').tooltip('remove');

            wavesurfer.regions.list[regionToCreate.id].remove();
            regionToCreate = {};
            wavesurfer.playPause();
        });

        $('.chips').on('chip.add', function(e, chip){
            $('#annotationForm button').removeClass('disabled');
        });

        Materialize.toast('You can create annotations or comments when the audio is playing.', 3000);
        $('.tooltipped').tooltip({html: true});
    });
  </script>
{%- endblock %}
